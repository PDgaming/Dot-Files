#!/usr/bin/env bash

#
# Copyright (C) 2015 James Murphy
# Licensed under the terms of the GNU GPL v2 only.
#
# i3blocks blocklet script to monitor bandwidth usage

iface="${BLOCK_INSTANCE}"
iface="${IFACE:-$iface}"
dt="${DT:-3}"
LABEL="${LABEL:- }"
printf_command="${PRINTF_COMMAND:-"printf \"%5.1f%s/s|%5.1f%s/s\", rx, unit_rx, wx, unit_wx;"}"

function default_interface {
    ip route | awk '/^default via/ {print $5; exit}'
}

function check_proc_net_dev {
    if [ ! -f "/proc/net/dev" ]; then
        echo "/proc/net/dev not found"
        exit 1
    fi
}

function list_interfaces {
    check_proc_net_dev
    echo "Interfaces in /proc/net/dev:"
    grep -o "^[^:]\\+:" /proc/net/dev | tr -d " :"
}

while getopts i:t:u:p:lh opt; do
    case "$opt" in
        i) iface="$OPTARG" ;;
        t) dt="$OPTARG" ;;
        u) # This option is now ignored as units are auto-selected
           ;;
        p) printf_command="$OPTARG" ;;
        l) list_interfaces && exit 0 ;;
        h) printf \
"Usage: bandwidth3 [-i interface] [-t time] [-p printf_command] [-l] [-h]
Options:
-i\tNetwork interface to measure. Default determined using \`ip route\`.
-t\tTime interval in seconds between measurements. Default: 3
-p\tAwk command to be called after a measurement is made.
\tDefault: printf \"<span font='FontAwesome'> </span>%%-5.1f/%%5.1f %%s/s\\\\n\", rx, wx, unit;
\tExposed variables: rx, wx, tx, unit_rx, unit_wx, iface
-l\tList available interfaces in /proc/net/dev
-h\tShow this help text
" && exit 0;;
    esac
done

check_proc_net_dev

iface="${iface:-$(default_interface)}"
while [ -z "$iface" ]; do
    echo No default interface
    sleep "$dt"
    iface=$(default_interface)
done

# Check if the interface exists
init_line=$(cat /proc/net/dev | grep "^[ ]*$iface:")
if [ -z "$init_line" ]; then
    echo Interface not found in /proc/net/dev: "$iface"
    exit 1
fi

init_received=$(awk '{print $2}' <<< $init_line)
init_sent=$(awk '{print $10}' <<< $init_line)

(while true; do cat /proc/net/dev; sleep "$dt"; done) |\
stdbuf -oL grep "^[ ]*$iface:" |\
awk -v dt="$dt" -v iface="$iface" '
BEGIN{
    old_received='"$init_received"';
    old_sent='"$init_sent"';
    units_arr[0]="Kb"; units_arr[1]="Mb"; units_arr[2]="Gb"; units_arr[3]="Tb";
    scalar = 1024 / 8;
}
{
    received=$2;
    sent=$10;
    
    # Calculate raw bandwidth in Kbps
    rx_raw = ((received - old_received) * 8) / 1024 / dt;
    wx_raw = ((sent - old_sent) * 8) / 1024 / dt;

    # Determine the unit and scale factor for rx
    rx = rx_raw;
    unit_idx_rx = 0;
    while (rx >= 1024 && unit_idx_rx < 3) {
        rx /= 1024;
        unit_idx_rx++;
    }
    
    # Determine the unit and scale factor for wx
    wx = wx_raw;
    unit_idx_wx = 0;
    while (wx >= 1024 && unit_idx_wx < 3) {
        wx /= 1024;
        unit_idx_wx++;
    }

    unit_rx = units_arr[unit_idx_rx];
    unit_wx = units_arr[unit_idx_wx];
    
    # Expose tx variable (total bandwidth)
    tx = rx + wx;

    old_received=received;
    old_sent=sent;

    if(rx >= 0 && wx >= 0){
        '"$printf_command"';
        fflush(stdout);
    }
}
'
